
local ç‰ˆæœ¬å·="1.0"

local å¸®åŠ©å†…å®¹=[[
</big><font color=red><b>å¸®åŠ©è¯´æ˜</b></font></big>
--æ— éšœç¢ç‰ˆä¸“ç”¨è„šæœ¬
--è„šæœ¬åç§°: ä¸»é¢˜èƒŒæ™¯åˆ‡æ¢
--ç”¨é€”ï¼šä½¿ç”¨è„šæœ¬ç›®å½•ä¸­å›¾ç‰‡åº“æ–‡ä»¶æ›¿æ¢ä¸»é¢˜ä¸­çš„èƒŒæ™¯å›¾,å¹¶è‡ªåŠ¨åˆ·æ–°ä¸»é¢˜æ˜¾ç¤ºæ–°çš„èƒŒæ™¯å›¾
--ç‰ˆæœ¬å·: 1.0
â–‚â–‚â–‚â–‚â–‚â–‚â–‚â–‚
æ—¥æœŸ: 2020å¹´11æœˆ27æ—¥ğŸ—“ï¸
å†œå†: é¼ ğŸåºšå­å¹´åæœˆåä¸‰
æ—¶é—´: 18:24:23ğŸ••
æ˜ŸæœŸ: å‘¨äº”
--åˆ¶ä½œè€…: é£ä¹‹æ¼«èˆ
--é¦–å‘qqç¾¤: Rime åŒæ–‡æ–‹(458845988)
--é‚®ç®±: bj19490007@163.com(ä¸ä¸€å®šåŠæ—¶çœ‹åˆ°)

--ä½¿ç”¨è¯´æ˜
<b>
â‘ å¿…é¡»å…ˆåœ¨ä¸»é¢˜æ–‡ä»¶ä¸­è®¾ç½®èƒŒæ™¯å›¾ç‰‡åç§°
æŸ¥æ‰¾keyboard_back_colorèŠ‚ç‚¹,å¯èƒ½æœ‰å¤šä¸ª,æ¨èå‘½åä¸º background.gif,ä»¥ä¾›ä½¿ç”¨åŠ¨å›¾
â‘¡å¦‚æœä½¿ç”¨äº†ä¸­æ–‡è¾“å…¥æ³•è®¾ç½®ä¸­çš„ é”®ç›˜å›¾æ ‡åŒ…, å…¶ä¸­ backgroundå›¾ç‰‡éœ€ç§»é™¤
åŒæ ·ä½¿ç”¨äº† è‡ªå®šä¹‰é¢œè‰²,å…¶ä¸­èƒŒæ™¯é”®ç›˜å¿…é¡»ä¸ºç©ºæˆ–é»˜è®¤å€¼,å¦åˆ™ä¼šè¢«è®¾ç½®å†…å®¹ä¼˜å…ˆè¦†ç›–
</b>

--è„šæœ¬é…ç½®è¯´æ˜
<b>ç”¨æ³•ä¸€</b>
â‘ æ”¾åˆ°è„šæœ¬å¯åŠ¨å™¨->è„šæœ¬åº“ç›®å½• ä¸‹ä»»æ„ä½ç½®åŠå­æ–‡ä»¶å¤¹ä¸­,è„šæœ¬å¯åŠ¨å™¨è‡ªåŠ¨æ˜¾ç¤ºè¯¥è„šæœ¬
â‘¡ä¸»é¢˜æ–¹æ¡ˆæŒ‚è½½è„šæœ¬å¯åŠ¨å™¨
â‘¢æ˜¾ç¤ºä¸€ä¸ªé”®ç›˜ç•Œé¢,
å•å‡»å›¾ç‰‡åˆ‡æ¢,é•¿æŒ‰æ˜¾ç¤ºå›¾ç‰‡è·¯å¾„

--------------------
<b>ç”¨æ³•äºŒ</b>
ç¬¬â‘ æ­¥ å°† è„šæœ¬æ–‡ä»¶è§£å‹æ”¾ç½® Android/rime/script æ–‡ä»¶å¤¹å†…,
é»˜è®¤è„šæœ¬è·¯å¾„ä¸ºAndroid/rime/script/ä¸»é¢˜ä¸€é”®æ¢å›¾/ä¸»é¢˜èƒŒæ™¯åˆ‡æ¢.lua

ç¬¬â‘¡æ­¥ å‘ä¸»é¢˜æ–¹æ¡ˆä¸­åŠ å…¥æŒ‰é”®
ä»¥ XXX.trime.yamlä¸»é¢˜æ–¹æ¡ˆä¸ºä¾‹
æ‰¾åˆ°ä»¥ä¸‹èŠ‚ç‚¹preset_keys,åŠ å…¥ä»¥ä¸‹å†…å®¹

preset_keys:
  LuaTheme0: {label: ä¸»é¢˜, send: function, command: 'ä¸»é¢˜ä¸€é”®æ¢å›¾/ä¸»é¢˜èƒŒæ™¯åˆ‡æ¢.lua', option: ""}#æ˜¾ç¤ºrimeç›®å½•ä¸‹æ‰€æœ‰ä¸»é¢˜åˆ°ä¸€ä¸ªé”®ç›˜,ç‚¹å‡»åˆ‡æ¢å¹¶æ˜¾ç¤º
  LuaTheme1: {label: ä¸»é¢˜1, send: function, command: 'ä¸»é¢˜æ“ä½œ/ä¸»é¢˜æ“ä½œ.lua', option: "ã€Šã€Šå‘½ä»¤è¡Œã€‹ã€‹ã€ã€å›¾ç‰‡åã€‘ã€‘"}#å›¾ç‰‡åä¸ºè‡ªå®šä¹‰é¡¹,å›¾ç‰‡åº“ä¸­æ–‡ä»¶åå³å¯
  LuaTheme_fresh: {label: åˆ·æ–°ä¸»é¢˜, send: function, command: 'ä¸»é¢˜æ“ä½œ/ä¸»é¢˜æ“ä½œ.lua', option: "ã€Šã€Šå‘½ä»¤è¡Œã€‹ã€‹ã€ã€éšæœºå›¾ç‰‡ã€‘ã€‘"}#éšæœºæ›´æ¢ä¸€å¼ èƒŒæ™¯å›¾ç‰‡
  
å‘è¯¥ä¸»é¢˜æ–¹æ¡ˆä»»æ„é”®ç›˜æŒ‰é”®ä¸­åŠ å…¥ä¸Šè¿°æŒ‰é”®æ—¢å¯


]]


require "import"
import "android.widget.*"
import "android.view.*"
import "android.graphics.RectF"
import "java.io.*"
import "com.osfans.trime.*" --è½½å…¥åŒ…
import "android.text.Html"
import "android.graphics.drawable.StateListDrawable"

--dofile(tostring(service.getLuaExtDir("script")).."/åŒ…/å…¶å®ƒ/ä¸»é”®ç›˜.lua")
import "com.osfans.trime.*" --è½½å…¥åŒ…
import "yaml"


local å‚æ•°=(...)

local è¾“å…¥æ³•ç›®å½•=tostring(service.getLuaExtDir("")).."/"
local è„šæœ¬ç›®å½•=tostring(service.getLuaExtDir("script")).."/"
local è„šæœ¬è·¯å¾„=debug.getinfo(1,"S").source:sub(2)--è·å–Luaè„šæœ¬çš„å®Œæ•´è·¯å¾„
local çº¯è„šæœ¬å=File(è„šæœ¬è·¯å¾„).getName()
local ç›®å½•=string.sub(è„šæœ¬è·¯å¾„,1,#è„šæœ¬è·¯å¾„-#çº¯è„šæœ¬å)
local è„šæœ¬ç›¸å¯¹è·¯å¾„=string.sub(è„šæœ¬è·¯å¾„,#è„šæœ¬ç›®å½•+1)

local ä¸»é¢˜å®ä¾‹=Config.get()
local å½“å‰ä¸»é¢˜=tostring(ä¸»é¢˜å®ä¾‹.getTheme())


local è¾“å…¥æ³•ç›®å½•=tostring(service.getLuaExtDir("")).."/"
local ä¸»é¢˜ç»„=Config.get()
local å½“å‰ä¸»é¢˜0=ä¸»é¢˜ç»„.getTheme()
local ä¸»é¢˜æ–‡ä»¶=è¾“å…¥æ³•ç›®å½•..å½“å‰ä¸»é¢˜0..".yaml"
local yamlç»„ = yaml.load(io.readall(ä¸»é¢˜æ–‡ä»¶))

local èƒŒæ™¯å›¾ç‰‡ç»„={}

for k,v pairs(yamlç»„["preset_color_schemes"])
 
 local ä¸»é¢˜èƒŒæ™¯å›¾ç‰‡=yamlç»„["preset_color_schemes"][k]["keyboard_back_color"]
 èƒŒæ™¯å›¾ç‰‡ç»„[#èƒŒæ™¯å›¾ç‰‡ç»„+1]=ä¸»é¢˜èƒŒæ™¯å›¾ç‰‡
end





local å›¾ç‰‡ç»„={}



local æ’ä»¶åŒ…=tostring(service.getLuaExtDir("script")).."/åŒ…/æ–‡ä»¶æ“ä½œ/é€’å½’æŸ¥æ‰¾æ–‡ä»¶.lua"
if File(æ’ä»¶åŒ…).exists() then
 æ’ä»¶åŒ…=ç›®å½•.."é€’å½’æŸ¥æ‰¾æ–‡ä»¶.text"
end
dofile(æ’ä»¶åŒ…)
å›¾ç‰‡ç»„=é€’å½’æŸ¥æ‰¾æ–‡ä»¶(File(ç›®å½•.."/å›¾ç‰‡åº“/"),".*")
table.sort(å›¾ç‰‡ç»„)--æ•°ç»„æ’åº



local function åˆ·æ–°å½“å‰ä¸»é¢˜()
  ä¸»é¢˜å®ä¾‹.setTheme(tostring(å½“å‰ä¸»é¢˜)) 
 local æŒ‰é”®ç•Œé¢=Trime.getService()
 æŒ‰é”®ç•Œé¢.initKeyboard()
 print("å½“å‰èƒŒæ™¯å·²åˆ·æ–°")
 --service.sendEvent("Keyboard_default")
end

local function javaéšæœºæ•´æ•°(æœ€å¤§æ•°)
 import "java.util.*"
 local éšæœºæ•°ç§å­ =Random()
 local éšæœºæ•´æ•°=éšæœºæ•°ç§å­.nextInt(æœ€å¤§æ•°)+1
 return éšæœºæ•´æ•°
end--function javaéšæœºæ•´æ•°


local function ä¸»é¢˜èƒŒæ™¯(å›¾ç‰‡è·¯å¾„)
 for i=1,#èƒŒæ™¯å›¾ç‰‡ç»„ do
    local è·¯å¾„=è¾“å…¥æ³•ç›®å½•..å½“å‰ä¸»é¢˜.."/"..èƒŒæ™¯å›¾ç‰‡ç»„[i]
    LuaUtil.copyDir(å›¾ç‰‡è·¯å¾„,è·¯å¾„)
  end
  --é—´éš”æ—¶é—´
  task(300,function() end)
  åˆ·æ–°å½“å‰ä¸»é¢˜()

end

if å‚æ•°!=nil && string.find(å‚æ•°,"ã€Šã€Šå‘½ä»¤è¡Œã€‹ã€‹")!=nil && string.find(å‚æ•°,"ã€ã€éšæœºå›¾ç‰‡ã€‘ã€‘")!=nil then
 ä¸»é¢˜èƒŒæ™¯(å›¾ç‰‡ç»„[javaéšæœºæ•´æ•°(#å›¾ç‰‡ç»„)])--ä¸»é¢˜èƒŒæ™¯éšæœº
 return
end

if å‚æ•°!=nil && string.find(å‚æ•°,"ã€Šã€Šå‘½ä»¤è¡Œã€‹ã€‹")!=nil && string.find(å‚æ•°,"ã€ã€")!=nil && string.find(å‚æ•°,"ã€‘ã€‘")!=nil then
 local å›¾ç‰‡å=string.sub(å‚æ•° ,string.find(å‚æ•°,"ã€ã€")+6,string.find(å‚æ•°,"ã€‘ã€‘")-1)
 local è·¯å¾„=ç›®å½•.."/å›¾ç‰‡åº“/"..å›¾ç‰‡å
 if File(è·¯å¾„).exists()==false then
   print(è·¯å¾„.." å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨")
   return
 end
 åˆ·æ–°ä¸»é¢˜(ä¸»é¢˜æ–‡ä»¶)
 return
end


dofile_ä¿¡æ¯è¡¨=nil
dofile_ä¿¡æ¯è¡¨={}
local function æ˜¾ç¤ºå¸®åŠ©(å†…å®¹)
   dofile_ä¿¡æ¯è¡¨.ä¸Šçº§è„šæœ¬=è„šæœ¬è·¯å¾„
   dofile_ä¿¡æ¯è¡¨.ä¸Šçº§è„šæœ¬æ‰€åœ¨ç›®å½•=ç›®å½•
   dofile_ä¿¡æ¯è¡¨.ä¸Šçº§è„šæœ¬ç›¸å¯¹è·¯å¾„=è„šæœ¬ç›¸å¯¹è·¯å¾„
   dofile_ä¿¡æ¯è¡¨.çº¯è„šæœ¬å=çº¯è„šæœ¬å:sub(1,-5)
   dofile_ä¿¡æ¯è¡¨.å†…å®¹=å†…å®¹
   
   
   dofile(ç›®å½•.."å¸®åŠ©æ¨¡å—.text")--å¯¼å…¥æ¨¡å—

end




local ids={}
local data={}
local item={LinearLayout,
  layout_width=-1,
  layout_height="110dp",
  padding="2dp",
  orientation="vertical",
  gravity=17,
  {ImageView;
      id="img";
      layout_width="100dp"; 
      layout_height="80dp"; 
      layout_gravity="center"; 
      adjustViewBounds="true"; 
      scaleType="fitXY";
      --layout_width="400dp";
      --layout_height="200dp";
    },
  
  {CardView,
    radius="10dp",
    layout_height="12dp",
    CardElevation=0,
    layout_width=-1,
    BackgroundColor=0x49d3d7da,
    --gravity=3|17,
    
    {LinearLayout,
    layout_width=-1,
    --BackgroundColor=0x49d3d7da,
    --gravity=3|17,

}}}
      
      
      
local adp=LuaAdapter(service,data,item)


--åˆ·æ–°åˆ—è¡¨
local function fresh(t)
  ids.title.setText(çº¯è„šæœ¬å:sub(1,-5))
  table.clear(data)
  if type(t)~="table" then
    local ts={}
    for a in utf8.gmatch(tostring(t),"%S")
      table.insert(ts,a)
    end
    t=ts
  end
  local i=0
  for _,v in ipairs(t) do
    i=i+1
    
    table.insert(data,{img=å›¾ç‰‡ç»„[i],b=" "..tostring(i)})
  end
  
  adp.notifyDataSetChanged()
end




local function Back() --ç”ŸæˆåŠŸèƒ½é”®èƒŒæ™¯
  local bka=LuaDrawable(function(c,p,d)
    local b=d.bounds
    b=RectF(b.left,b.top,b.right,b.bottom)
    p.setColor(0xffffffff)
    c.drawRoundRect(b,20,20,p) --åœ†è§’20
  end)
  local bkb=LuaDrawable(function(c,p,d)
    local b=d.bounds
    b=RectF(b.left,b.top,b.right,b.bottom)
    p.setColor(0x49d3d7da)
    c.drawRoundRect(b,20,20,p)
  end)

  local stb=StateListDrawable()
  stb.addState({-android.R.attr.state_pressed},bkb)
  stb.addState({android.R.attr.state_pressed},bka)
  return stb
end

local function Icon(k,s) --è·å–kåŠŸèƒ½å›¾æ ‡ï¼Œæ²¡æœ‰è¿”å›s
  k=Key.presetKeys[k]
  return k and k.label or s
end

local function Bu_R(id) --ç”ŸæˆåŠŸèƒ½é”®
  local Bu={LinearLayout,
    layout_height=-1,
    layout_width=-1,
    layout_weight=1,
    padding="2dp",
    {FrameLayout,
      layout_height=-1,
      layout_width=-1,
      Background=Back(),
      {TextView,
        gravity=17|48,
        layout_height=-1,
        layout_width=-1,
        layout_marginTop="2dp",
        textColor=0xff232323,
        textSize="10dp"},
      {TextView,
        gravity=17,
        layout_height=-1,
        layout_width=-1,
        textColor=0xff232323,
        textSize="18dp"}}}
  local msg=Bu[2][2] --ä¸Šæ ‡ç­¾
  local label=Bu[2][3] --ä¸»æ ‡ç­¾
  
 
  if id==2 then
    label.text=Icon("Keyboard_default","è¿”å›")
    Bu.onClick=function()
      service.sendEvent("Keyboard_default")
    end
   elseif id==1 then
    label.text=Icon("BackSpace","âŒ«")
    Bu.onClick=function()
      service.sendEvent("BackSpace")
    end
    elseif id==3 then
    label.text="éšæœº"
    Bu.onClick=function()
      ä¸»é¢˜èƒŒæ™¯(å›¾ç‰‡ç»„[javaéšæœºæ•´æ•°(#å›¾ç‰‡ç»„)])--ä¸»é¢˜èƒŒæ™¯éšæœº
    end
    elseif id==4 then
    label.text="å¸®åŠ©"
    Bu.onClick=function()
      æ˜¾ç¤ºå¸®åŠ©(å¸®åŠ©å†…å®¹)
    end
    Bu.OnLongClickListener={onLongClick=function() return true end}
  end
  return Bu
end

local height="240dp" --é”®ç›˜é«˜åº¦
pcall(function()
  --é”®ç›˜è‡ªé€‚åº”é«˜åº¦ï¼Œæ—§ç‰ˆä¸­æ–‡ä¸æ”¯æŒï¼Œæ”¾pcallé‡Œé˜²æŠ¥é”™
  height=service.getLastKeyboardHeight()
end)


local layout={LinearLayout,
  orientation=1,
  --é”®ç›˜é«˜åº¦
  layout_height=height,
  layout_width=-1,
  --èƒŒæ™¯é¢œè‰²
  --BackgroundColor=0xffd7dddd,
  {TextView,
    id="title",
    layout_height="30dp",
    layout_width=-1,
    text="",
    gravity="center",
    paddingLeft="2dp",
    paddingRight="2dp",
    BackgroundColor=0x49d3d7da
    },
    {LinearLayout,
    gravity="right",
    layout_height=-1,
    {LinearLayout,
      id="main",
      orientation=1,
      --å³ä¾§åŠŸèƒ½é”®å®½åº¦
      layout_weight=1,
      layout_height=-1,
      layout_gravity=8|3,
      {GridView, --åˆ—è¡¨æ§ä»¶
        id="list",
        numColumns=2, --6åˆ—
        paddingLeft="2dp",
        paddingRight="2dp",
        layout_width=-1,
        layout_weight=1}},

   {LinearLayout,
      orientation=1,
      layout_weight=1,
      layout_width="100dp",
      layout_height=-1,
      --layout_gravity=5|84,
      Bu_R(4),
      Bu_R(3),
      Bu_R(1),
      Bu_R(2)
      },
}}



layout=loadlayout(layout,ids)




ids.list.Adapter=adp

ids.list.onItemClick=function(l,v,p)
  ä¸»é¢˜èƒŒæ™¯(å›¾ç‰‡ç»„[p+1])
end

ids.list.onItemLongClick=function(l,v,p)
  print(å›¾ç‰‡ç»„[p+1])
  return true
end




  fresh(å›¾ç‰‡ç»„)
  local æ ‡é¢˜=çº¯è„šæœ¬å:sub(1,-5)
  æ ‡é¢˜=æ ‡é¢˜..ç‰ˆæœ¬å·
ids.title.setText(æ ‡é¢˜)


local Bus={LinearLayout,
  paddingLeft="2dp",
  layout_width=-1}


ids.main.addView(loadlayout(Bus))


service.setKeyboard(layout)






